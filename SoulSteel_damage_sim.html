<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ダメージシミュレーター</title>
<style>
body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP";padding:20px;max-width:980px;margin:auto;color:#222;background:#fafafa}
h1{font-size:1.3rem;margin-bottom:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:12px}
label{display:block;font-size:.85rem;margin-bottom:4px}
input[type=number]{width:100%;padding:6px;border:1px solid #ccc;border-radius:5px}
select{padding:6px;border-radius:5px;width:100%}
button{padding:8px 12px;border:none;border-radius:6px;background:#2b6cb0;color:white;cursor:pointer}
.result{margin-top:14px;padding:10px;border-radius:6px;background:white;border:1px solid #ddd}
.small{font-size:.85rem;color:#555;margin-bottom:8px}
</style>
</head>
<body>
<h1>ダメージシミュレーター</h1>

<div class="grid">
  <div>
    <label>基礎ダメージ (N)</label>
    <input id="base" type="number" value="100" />
  </div>
  <div>
    <label>攻撃属性</label>
    <select id="attr">
      <option value="斬撃">斬撃</option>
      <option value="貫通">貫通</option>
      <option value="鈍器">鈍器</option>
      <option value="神秘">神秘</option>
      <option value="汚染">汚染</option>
      <option value="空気">空気</option>
      <option value="炎">炎</option>
      <option value="電力">電力</option>
      <option value="土">土</option>
    </select>
  </div>
  <div>
    <label>クリティカル率 (0〜1)</label>
    <input id="critRate" type="number" step="0.01" value="0.28" />
  </div>
  <div>
    <label>クリティカルダメージ (例:0.36)</label>
    <input id="critDmg" type="number" step="0.01" value="0.36" />
  </div>
</div>

<h3>バフ入力（%で入力、例: 25 = 25%）</h3>
<div class="grid" id="buffs"></div>

<div style="margin-top:10px;display:flex;gap:8px">
  <button id="calc">計算</button>
  <button id="reset" class="secondary" style="background:#888">初期化</button>
  <button id="copy" style="background:#4CAF50">結果をクリップボードにコピー</button>
</div>

<div class="result" id="result">
  <p>まだ計算してません。</p>
</div>

<script>
const buffs = [
  "斬撃","貫通","鈍器","神秘","汚染","空気","炎","電力","土",
  "物理攻撃","魔法攻撃","自然","エレメンタル"
];
const buffContainer = document.getElementById('buffs');
for(const b of buffs){
  const div = document.createElement('div');
  div.innerHTML = `<label>${b} (%)</label><input type="number" id="buff_${b}" step="0.1" value="0">`;
  buffContainer.appendChild(div);
}

const attrBuffMap = {
  "斬撃":["斬撃","物理攻撃"],
  "貫通":["貫通","物理攻撃"],
  "鈍器":["鈍器","物理攻撃"],
  "神秘":["神秘","魔法攻撃"],
  "汚染":["汚染","自然"],
  "空気":["空気","エレメンタル"],
  "炎":["炎","エレメンタル"],
  "電力":["電力","自然"],
  "土":["土","エレメンタル"]
};

function getNumber(id){
  const v = Number(document.getElementById(id).value);
  return isFinite(v) ? v : 0;
}

function computeNprime(N, p, q){
  const hasP = p > 0;
  const hasQ = q > 0;
  if(hasP && hasQ){
    return N + N*(1+p) + N*(1+q);
  } else if(hasP && !hasQ){
    return N + N*(1+p);
  } else if(!hasP && hasQ){
    return N + N*(1+q);
  } else {
    return N;
  }
}

document.getElementById('calc').addEventListener('click', ()=>{
  const N = getNumber('base');
  const attr = document.getElementById('attr').value;
  const critRate = getNumber('critRate');
  const critDmg = getNumber('critDmg');
  const [buffA, buffB] = attrBuffMap[attr] || [];
  const p = getNumber('buff_'+buffA) / 100;
  const q = getNumber('buff_'+buffB) / 100;

  const Nprime = computeNprime(N, p, q);

  const normal = Nprime;
  const critical = Nprime * (2 + critDmg);
  const expected = normal * (1 - critRate) + critical * critRate;

  document.getElementById('result').innerHTML = `
    <b>属性:</b> ${attr}<br>
    <b>対応バフ:</b> ${buffA}, ${buffB}<br>
    <b>入力:</b> ${buffA}: ${p*100}% ／ ${buffB}: ${q*100}%<br>
    <hr>
    <b>非クリティカル時のダメージ:</b> ${normal.toFixed(2)}<br>
    <b>クリティカル時のダメージ:</b> ${critical.toFixed(2)}<br>
    <b>期待値 (確率考慮):</b> ${expected.toFixed(2)}<br>
  `;
});

document.getElementById('reset').addEventListener('click', ()=>{
  document.getElementById('base').value = 100;
  document.getElementById('critRate').value = 0.28;
  document.getElementById('critDmg').value = 0.36;
  for(const b of buffs){ document.getElementById('buff_'+b).value = 0; }
  document.getElementById('result').innerHTML = '<p>リセットしました。</p>';
});

document.getElementById('copy').addEventListener('click', async ()=>{
  const txt = document.getElementById('result').innerText;
  try {
    await navigator.clipboard.writeText(txt);
    alert('結果をコピーした。')
  } catch (e) {
    alert('コピーに失敗。手動で選択してコピーしてくれ。');
  }
});
</script>
</body>
</html>